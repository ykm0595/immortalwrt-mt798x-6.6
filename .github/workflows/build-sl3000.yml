name: Build-SL3000-Full

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ============================
    # ✅ 终极磁盘清理（释放 25–35GB）
    # ============================
    - name: Ultimate Disk Clean
      run: |
        echo "=== Removing heavy directories ==="
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /opt/hostedtoolcache || true
        sudo rm -rf /usr/lib/jvm || true
        sudo rm -rf /usr/local/share/boost || true
        sudo rm -rf /opt/az || true
        sudo rm -rf /opt/microsoft || true
        sudo rm -rf /usr/lib/google-cloud-sdk || true

        # 强制卸载 overlayfs（关键）
        sudo umount /usr/local/lib/android || true
        sudo umount /usr/share/dotnet || true

        # 再删一次（关键）
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /usr/share/dotnet || true

        # 删除 docker 层
        sudo systemctl stop docker || true
        sudo rm -rf /var/lib/docker || true

        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*

        echo "=== Disk after cleanup ==="
        df -h

    # ============================
    # ✅ 自动检测磁盘空间（不足 20GB 直接退出）
    # ============================
    - name: Check Disk Space
      run: |
        AVAIL=$(df / | tail -1 | awk '{print $4}')
        if [ "$AVAIL" -lt 20971520 ]; then
          echo "❌ ERROR: Not enough disk space (<20GB)."
          exit 1
        fi
        echo "✅ Disk space OK"

    # ============================
    # ✅ 安装依赖
    # ============================
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils \
          rsync unzip zlib1g-dev file wget ccache

    # ============================
    # ✅ ccache 缓存
    # ============================
    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-${{ github.sha }}
        restore-keys: |
          ccache-${{ runner.os }}-

    - name: Configure ccache
      run: |
        echo 'export CC="ccache gcc"' >> ~/.bashrc
        echo 'export CXX="ccache g++"' >> ~/.bashrc
        source ~/.bashrc
        ccache -M 5G
        ccache -s

    # ============================
    # ✅ 构建前自动清理（避免脏缓存）
    # ============================
    - name: Clean Build Directories
      run: |
        echo "=== Cleaning build directories ==="
        rm -rf build_dir staging_dir tmp
        mkdir -p build_dir staging_dir tmp

    # ============================
    # ✅ 精准 feeds（避免 exim/python 警告）
    # ============================
    - name: Prepare Feeds
      run: |
        ./scripts/feeds update -a

        # 只安装你需要的包
        ./scripts/feeds install -p packages docker dockerd docker-compose
        ./scripts/feeds install -p luci luci-app-dockerman luci-app-samba4 luci-app-wireguard luci-app-openvpn luci-app-ddns luci-app-upnp
        ./scripts/feeds install -a -p routing

    # ============================
    # ✅ 应用 SL3000-Full 配置
    # ============================
    - name: Apply Full Config
      run: |
        cp configs/sl3000-full.config .config
        make defconfig

    # ============================
    # ✅ 构建固件
    # ============================
    - name: Build Firmware
      run: |
        make -j$(nproc) BUILD_LOG=1 || make -j1 V=s

    # ============================
    # ✅ 上传固件
    # ============================
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-Full
        path: bin/targets/
