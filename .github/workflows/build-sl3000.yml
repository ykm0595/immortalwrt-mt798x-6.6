name: Build-SL3000-3Variants

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet \
                    /usr/local/lib/android \
                    /opt/ghc \
                    /opt/hostedtoolcache \
                    /usr/local/share/boost \
                    /usr/lib/jvm \
                    /opt/az \
                    /opt/microsoft \
                    /usr/lib/google-cloud-sdk
        sudo docker image prune -a -f
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils \
          rsync unzip zlib1g-dev file wget ccache

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-${{ github.sha }}
        restore-keys: |
          ccache-${{ runner.os }}-

    - name: Configure ccache
      run: |
        echo 'export CC="ccache gcc"' >> ~/.bashrc
        echo 'export CXX="ccache g++"' >> ~/.bashrc
        source ~/.bashrc
        ccache -M 5G
        ccache -s

    - name: Prepare Feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # ============================
    # ✅ 构建 1：稳定版
    # ============================
    - name: Build Stable Version
      run: |
        echo "=== Building Stable Version ==="
        cp configs/sl3000-stable.config .config
        make defconfig
        make -j$(nproc) || make -j1 V=s
        mkdir -p output/stable
        cp -r bin/targets/* output/stable/

    # ============================
    # ✅ 构建 2：Docker 版
    # ============================
    - name: Build Docker Version
      run: |
        echo "=== Building Docker Version ==="
        rm -rf bin/targets
        cp configs/sl3000-docker.config .config
        make defconfig
        make -j$(nproc) || make -j1 V=s
        mkdir -p output/docker
        cp -r bin/targets/* output/docker/

    # ============================
    # ✅ 构建 3：全功能版
    # ============================
    - name: Build Full Version
      run: |
        echo "=== Building Full Version ==="
        rm -rf bin/targets
        cp configs/sl3000-full.config .config
        make defconfig
        make -j$(nproc) || make -j1 V=s
        mkdir -p output/full
        cp -r bin/targets/* output/full/

    # ============================
    # ✅ 上传三套固件
    # ============================
    - name: Upload Stable Firmware
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-Stable
        path: output/stable/

    - name: Upload Docker Firmware
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-Docker
        path: output/docker/

    - name: Upload Full Firmware
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-Full
        path: output/full/
