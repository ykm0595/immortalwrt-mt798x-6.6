name: Build SL3000 Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils python3-setuptools \
            rsync unzip zlib1g-dev file wget ccache asciidoc libzstd-dev \
            libelf-dev ecj fastjar java-propose-classpath subversion \
            texinfo libtool patchutils jq

      - name: Prepare feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ✅ 关键：清理旧 toolchain，解决 kernel-headers 失败
      - name: Full clean toolchain & build cache
        run: |
          make clean || true
          make dirclean || true
          rm -rf tmp/

      # ✅ 使用你仓库里的 sl3000-full.config
      - name: Load SL3000 config fragment
        run: |
          if [ -f configs/sl3000-full.config ]; then
            echo "Using configs/sl3000-full.config"
            cp configs/sl3000-full.config .config
          else
            echo "ERROR: configs/sl3000-full.config not found!"
            exit 1
          fi
          echo "===== Loaded fragment config ====="
          cat .config

      # ✅ 自动补齐依赖，生成真正的 .config
      - name: Generate final .config
        run: |
          make defconfig
          echo "===== Final .config ====="
          head -n 200 .config

      # ✅ 单独构建 toolchain，方便排查 kernel-headers
      - name: Build toolchain
        run: |
          make toolchain/install -j1 V=s

      # ✅ 正式构建固件
      - name: Build firmware
        run: |
          make -j$(nproc) V=s

      # ✅ 打包输出
      - name: Package firmware
        run: |
          mkdir -p output
          tar -czf output/sl3000-firmware.tar.gz bin

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-firmware
          path: output/sl3000-firmware.tar.gz
