name: Build SL3000 Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils python3-setuptools \
            python-is-python3 \
            rsync unzip zlib1g-dev file wget ccache asciidoc libzstd-dev \
            libelf-dev ecj fastjar java-propose-classpath subversion \
            texinfo libtool patchutils jq

          # 兼容部分仍然寻找 /usr/bin/python 的旧脚本
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true

      - name: Prepare feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ✅ 清理旧 toolchain，避免 kernel-headers 等历史残留
      - name: Full clean toolchain & build cache
        run: |
          make clean || true
          make dirclean || true
          rm -rf tmp/

      # ✅ 使用你仓库里的 sl3000-full.config 作为完整 .config
      - name: Load SL3000 full config
        run: |
          if [ -f configs/sl3000-full.config ]; then
            echo "Using configs/sl3000-full.config as .config"
            cp configs/sl3000-full.config .config
          else
            echo "ERROR: configs/sl3000-full.config not found!"
            exit 1
          fi
          echo "===== Initial .config ====="
          head -n 80 .config || cat .config

      # ✅ defconfig 补依赖 + 强校验设备 / profile，防止跳到 abt_asr3000
      - name: Defconfig and verify SL3000 target
        run: |
          make defconfig

          echo "===== .config after defconfig ====="
          head -n 160 .config

          echo "===== Verify SL3000 target ====="
          # 这里使用我们在源码中定义的设备 ID：sl3000（无中横线）
          if ! grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000=y' .config; then
            echo "ERROR: SL3000 target missing after defconfig!"
            exit 1
          fi

          # 强制修正/统一 profile，防止残留其他 DEVICE_xxx
          sed -i '/^CONFIG_TARGET_PROFILE=/d' .config
          echo 'CONFIG_TARGET_PROFILE="DEVICE_sl3000"' >> .config
          echo "Fixed CONFIG_TARGET_PROFILE to DEVICE_sl3000"

          echo "===== Final verified .config (targets) ====="
          grep CONFIG_TARGET_ .config | head -n 40

      # ✅ 单独构建 toolchain（方便排查 kernel-headers / python 依赖等问题）
      - name: Build toolchain
        run: |
          make toolchain/install -j1 V=s

      # ✅ 正式构建固件
      - name: Build firmware
        run: |
          make -j$(nproc) V=s

      # ✅ 打包输出
      - name: Package firmware
        run: |
          mkdir -p output
          tar -czf output/sl3000-firmware.tar.gz bin

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-firmware
          path: output/sl3000-firmware.tar.gz
