name: Build SL-3000 Firmware

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'  # 每天 UTC 20 点（按需改）

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils python3-setuptools \
            rsync unzip zlib1g-dev file wget ccache asciidoc libzstd-dev \
            libelf-dev ecj fastjar java-propose-classpath subversion \
            texinfo libtool patchutils jq

      - name: Show kernel version config files
        run: |
          echo "===== include/kernel-version.mk ====="
          sed -n '1,80p' include/kernel-version.mk || true
          echo "===== include/kernel-6.6 ====="
          sed -n '1,80p' include/kernel-6.6 || true

      - name: Prepare feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ✅ 关键：彻底清理旧 toolchain / build 残留，避免 kernel-headers 版本错乱
      - name: Full clean (toolchain & build)
        run: |
          make clean || true
          make dirclean || true
          rm -rf tmp/

      # ✅ 使用仓库里的终极 .config，如果你是保存为 configs/sl3000-ultimate.config 就在这里拷贝
      - name: Use ultimate SL-3000 config
        run: |
          if [ -f configs/sl3000-ultimate.config ]; then
            cp configs/sl3000-ultimate.config .config
          else
            echo "configs/sl3000-ultimate.config not found, using existing .config"
          fi
          cat .config

      # ✅ 让依赖自动收敛，确保终极 config 不冲突
      - name: Defconfig
        run: |
          make defconfig

      # ✅ 先单独构建 toolchain，遇错方便定位（解决你现在的 kernel-headers 问题）
      - name: Build toolchain only (debug-friendly)
        run: |
          make toolchain/install -j1 V=s

      # ✅ 正式编译固件
      - name: Build firmware
        run: |
          make -j$(nproc) V=s
        # 如果你觉得日志太多，可以把 V=s 改成 V=sc 或去掉

      # ✅ 打包输出（bin 目录）
      - name: Organize artifacts
        run: |
          mkdir -p output
          if [ -d bin ]; then
            tar -czf output/sl3000-firmware-$(date +%Y%m%d-%H%M%S).tar.gz bin
          else
            echo "bin dir not found"
          fi

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-firmware
          path: output/*.tar.gz
          if-no-files-found: error
