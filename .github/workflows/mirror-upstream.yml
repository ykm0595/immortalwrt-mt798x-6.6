name: Sync-Upstream

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  sync:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout your repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/padavanonly/immortalwrt-mt798x-6.6.git || true
        git fetch upstream

    - name: Sync upstream but keep configs and workflows
      run: |
        git checkout main

        # 拉取上游到临时目录
        rm -rf upstream-tmp
        git clone --depth=1 https://github.com/padavanonly/immortalwrt-mt798x-6.6.git upstream-tmp

        # 只同步源码，不覆盖 configs/ 和 .github/
        rsync -av --delete \
          --exclude="configs/" \
          --exclude=".github/" \
          upstream-tmp/ ./

        # 提交更新
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add .
        git commit -m "Sync upstream without overwriting configs" || echo "No changes"
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
